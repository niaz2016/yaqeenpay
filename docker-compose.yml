services:
  postgres:
    image: postgres:15
    container_name: yaqeenpay-postgres
    environment:
      - POSTGRES_DB=YaqeenPay
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=L-v11wK8XyIadp4g
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - yaqeenpay-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile
    container_name: yaqeenpay-backend
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=YaqeenPay;Username=postgres;Password=L-v11wK8XyIadp4g;Port=5432;Pooling=true;MinPoolSize=5;MaxPoolSize=100;CommandTimeout=60;Timeout=60;
    depends_on:
      - postgres
    # No host port published. Traffic flows through the frontend (Nginx) container proxying /api.
    networks:
      - yaqeenpay-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
    container_name: yaqeenpay-frontend
    depends_on:
      - backend
    networks:
      - yaqeenpay-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: techtorio-gateway
    depends_on:
      - frontend
      - backend
    ports:
      - "80:80"
    networks:
      - yaqeenpay-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  yaqeenpay-network:
    driver: bridge

# Volumes for data persistence
volumes:
  postgres_data:
    driver: local