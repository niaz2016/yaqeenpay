<!DOCTYPE html>
<html>
<head>
    <title>Wallet Test Page</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px; margin: 5px; }
        .output { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Wallet Service Debug Page</h1>
    
    <div class="test-section">
        <h3>1. Test Authentication</h3>
        <button onclick="testAuth()">Check Auth Status</button>
        <div id="auth-output" class="output"></div>
    </div>

    <div class="test-section">
        <h3>2. Test Wallet Summary</h3>
        <button onclick="testWalletSummary()">Get Wallet Summary</button>
        <div id="summary-output" class="output"></div>
    </div>

    <div class="test-section">
        <h3>3. Test Transactions</h3>
        <button onclick="testTransactions()">Get Transactions</button>
        <div id="transactions-output" class="output"></div>
    </div>

    <div class="test-section">
        <h3>4. Test Top-Up</h3>
        <input type="number" id="topup-amount" placeholder="Amount" value="100" min="1">
        <select id="topup-channel">
            <option value="JazzCash">JazzCash</option>
            <option value="Easypaisa">Easypaisa</option>
            <option value="BankTransfer">BankTransfer</option>
            <option value="ManualAdjustment">ManualAdjustment</option>
        </select>
        <button onclick="testTopUp()">Test Top-Up</button>
        <div id="topup-output" class="output"></div>
    </div>

    <script>
        const API_BASE = 'https://localhost:7043/api';
        
        function getAuthHeaders() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            return {
                'Content-Type': 'application/json',
                'Authorization': user.token ? `Bearer ${user.token}` : ''
            };
        }

        async function testAuth() {
            const output = document.getElementById('auth-output');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            output.innerHTML = `User data: ${JSON.stringify(user, null, 2)}`;
            
            if (!user.token) {
                output.innerHTML += '\n\nERROR: No auth token found. Please login first.';
                output.className = 'output error';
                return false;
            }
            
            output.className = 'output success';
            return true;
        }

        async function testWalletSummary() {
            const output = document.getElementById('summary-output');
            
            if (!await testAuth()) {
                output.innerHTML = 'Please authenticate first.';
                return;
            }
            
            try {
                output.innerHTML = 'Loading wallet summary...';
                
                const response = await fetch(`${API_BASE}/wallets/summary`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                output.innerHTML = `Summary response:\n${JSON.stringify(data, null, 2)}`;
                output.className = 'output success';
                
            } catch (error) {
                output.innerHTML = `Error: ${error.message}`;
                output.className = 'output error';
            }
        }

        async function testTransactions() {
            const output = document.getElementById('transactions-output');
            
            if (!await testAuth()) {
                output.innerHTML = 'Please authenticate first.';
                return;
            }
            
            try {
                output.innerHTML = 'Loading transactions...';
                
                const response = await fetch(`${API_BASE}/wallets/transactions?page=1&pageSize=10`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                output.innerHTML = `Transactions response:\n${JSON.stringify(data, null, 2)}`;
                
                if (data.items && data.items.length > 0) {
                    output.innerHTML += `\n\nFirst transaction analysis:`;
                    const first = data.items[0];
                    output.innerHTML += `\n- ID: ${first.id}`;
                    output.innerHTML += `\n- Amount: ${first.amount} (type: ${typeof first.amount})`;
                    output.innerHTML += `\n- Type: ${first.type}`;
                    output.innerHTML += `\n- Status: ${first.status}`;
                    output.innerHTML += `\n- Description: ${first.description}`;
                    
                    if (first.amount === 0) {
                        output.innerHTML += `\n\n⚠️  WARNING: Transaction amount is 0!`;
                        output.className = 'output error';
                    } else {
                        output.className = 'output success';
                    }
                } else {
                    output.innerHTML += `\n\nNo transactions found.`;
                    output.className = 'output';
                }
                
            } catch (error) {
                output.innerHTML = `Error: ${error.message}`;
                output.className = 'output error';
            }
        }

        async function testTopUp() {
            const output = document.getElementById('topup-output');
            const amount = document.getElementById('topup-amount').value;
            const channel = document.getElementById('topup-channel').value;
            
            if (!await testAuth()) {
                output.innerHTML = 'Please authenticate first.';
                return;
            }
            
            if (!amount || amount <= 0) {
                output.innerHTML = 'Please enter a valid amount.';
                output.className = 'output error';
                return;
            }
            
            try {
                output.innerHTML = `Initiating top-up: ${amount} PKR via ${channel}...`;
                
                const requestBody = {
                    amount: parseFloat(amount),
                    currency: 'PKR',
                    channel: channel
                };
                
                const response = await fetch(`${API_BASE}/wallets/top-up`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
                }
                
                const data = await response.json();
                output.innerHTML = `Top-up response:\n${JSON.stringify(data, null, 2)}`;
                
                // Wait a moment then check transactions
                setTimeout(async () => {
                    output.innerHTML += '\n\nRefreshing transactions...';
                    await testTransactions();
                }, 1000);
                
                output.className = 'output success';
                
            } catch (error) {
                output.innerHTML = `Error: ${error.message}`;
                output.className = 'output error';
            }
        }
    </script>
</body>
</html>