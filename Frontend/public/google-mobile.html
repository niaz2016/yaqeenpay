<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TechTorio Google Sign-In (Mobile)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; padding: 24px; }
      .card { max-width: 480px; margin: 40px auto; padding: 24px; border: 1px solid #e5e7eb; border-radius: 12px; }
      h1 { font-size: 1.25rem; margin: 0 0 8px; }
      p { color: #4b5563; margin: 8px 0 16px; }
      .error { color: #b91c1c; margin-top: 12px; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Continue with Google</h1>
      <p>Choose your Google account to continue to TechTorio.</p>
      <div id="g_id_onload"></div>
      <div id="googleBtn"></div>
      <div id="status" class="error"></div>
    </div>

    <script>
      // Parse query params: client_id and redirect_uri
      function getParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }
      const clientId = getParam('client_id');
      const redirectUri = getParam('redirect_uri');

      const statusEl = document.getElementById('status');
      function setStatus(msg) { statusEl.textContent = msg || ''; }

      if (!clientId || !redirectUri) {
        setStatus('Missing client_id or redirect_uri');
      }

      window.handleGoogleCredential = function (response) {
        try {
          if (!response || !response.credential) {
            setStatus('No credential returned.');
            return;
          }
          // Redirect back to the app via custom scheme with the credential
          const url = redirectUri + '?credential=' + encodeURIComponent(response.credential);
          window.location.replace(url);
        } catch (e) {
          setStatus('Error handling credential: ' + (e && e.message ? e.message : e));
        }
      };

      function init() {
        if (!window.google || !window.google.accounts || !window.google.accounts.id) {
          setStatus('Google Identity Services failed to load.');
          return;
        }
        google.accounts.id.initialize({
          client_id: clientId,
          callback: window.handleGoogleCredential,
          auto_select: false,
          cancel_on_tap_outside: true
        });
        // Render a button as a backup and also prompt immediately
        google.accounts.id.renderButton(document.getElementById('googleBtn'), {
          type: 'standard', theme: 'outline', size: 'large', text: 'continue_with', shape: 'rectangular', width: 320
        });
        google.accounts.id.prompt();
      }

      window.addEventListener('load', function () {
        if (document.readyState === 'complete') {
          init();
        } else {
          window.setTimeout(init, 500);
        }
      });
    </script>
  </body>
</html>
