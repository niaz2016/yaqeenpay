# Payment & Escrow Flow - Visual Guide

## Flow Diagram

```
???????????????????????????????????????????????????????????????????????????????
?                           ORDER PAYMENT FLOW                                 ?
???????????????????????????????????????????????????????????????????????????????

STAGE 1: PAYMENT
?????????????????????????????????????????????????????????????????????????????
Endpoint: POST /orders/{orderId}/pay
Actor: Buyer

Order Status: Created/PaymentPending ? AwaitingShipment

????????????????                    ????????????????
? Buyer Wallet ?                    ?    Order     ?
????????????????                    ????????????????
? Total: 1000  ?                    ? Status:      ?
? Avail:  500  ? ??????????        ? Awaiting     ?
? Frozen: 500  ? ??????   ?        ? Shipment     ?
????????????????      ?   ?        ?              ?
                      ?   ?        ? IsAmountFroz:?
    wallet.Freeze()   ?   ?        ? true         ?
    (NOT deducted)    ?   ?        ?              ?
                      ?   ?        ? FrozenAmount:?
                      ?   ?????????? 500 PKR      ?
                      ?            ????????????????
                      ?
                      ? Step 1: Freeze funds
                      ?? Moves available ? frozen
                         (Total balance unchanged)


STAGE 2: SHIPMENT
?????????????????????????????????????????????????????????????????????????????
Endpoint: POST /orders/{orderId}/ship
Actor: Seller

Order Status: AwaitingShipment ? Shipped

????????????????                    ????????????????
? Buyer Wallet ?                    ?    Order     ?
????????????????                    ????????????????
? Total: 1000  ?                    ? Status:      ?
? Avail:  500  ?                    ? Shipped      ?
? Frozen: 500  ?                    ?              ?
????????????????                    ? IsAmountFroz:?
                                    ? true         ?
     NO CHANGES                     ?              ?
     Funds stay frozen              ? FrozenAmount:?
                                    ? 500 PKR      ?
                                    ????????????????


STAGE 3: DELIVERY CONFIRMATION
?????????????????????????????????????????????????????????????????????????????
Endpoint: POST /orders/{orderId}/confirm-delivery
Actor: Buyer

Order Status: Shipped/DeliveredPendingDecision ? Completed

????????????????                                  ????????????????
? Buyer Wallet ?                                  ?Seller Wallet ?
????????????????                                  ????????????????
? Total:  500  ????                          ?????? Total: 1500  ?
? Avail:  500  ?  ?                          ?    ? Avail: 1500  ?
? Frozen:   0  ?  ?  ????????????????       ?    ? Frozen:   0  ?
????????????????  ?  ?    Order     ?       ?    ????????????????
                  ?  ????????????????       ?
                  ?  ? Status:      ?       ?
   Transfer       ?  ? Completed    ?       ?    seller.Credit()
   FrozenToDebit()?  ?              ?       ?    (+500 available)
   (-500 frozen)  ???? IsAmountFroz:?????????
   (-500 total)      ? false        ?
                     ?              ?
                     ? CompletedDate?
                     ? set          ?
                     ????????????????

Step 1: buyerWallet.TransferFrozenToDebit()
  - Removes 500 from frozen balance
  - Removes 500 from total balance
  - Records FrozenToDebit transaction

Step 2: sellerWallet.Credit()
  - Adds 500 to available balance
  - Adds 500 to total balance
  - Records Credit transaction

Step 3: order.CompleteOrder()
  - Sets IsAmountFrozen = false
  - Sets status = Completed
  - Sets CompletedDate
```

## Key Points

### ?? Freeze Operation (Stage 1 Only)
```
wallet.FreezeAmount(amount, reason)
?? availableBalance -= amount  (decreases)
?? frozenBalance += amount     (increases)
?? totalBalance = unchanged    (same)
```

### ?? Transfer Operation (Stage 3 Only)
```
BUYER SIDE:
wallet.TransferFrozenToDebit(amount, reason)
?? frozenBalance -= amount     (decreases to 0)
?? totalBalance -= amount      (decreases)
?? availableBalance = unchanged

SELLER SIDE:
wallet.Credit(amount, reason)
?? availableBalance += amount  (increases)
?? totalBalance += amount      (increases)
?? frozenBalance = unchanged
```

## Wallet Balance Tracking

### Before Any Operations
```
Buyer:  [Total: 1000] [Available: 1000] [Frozen: 0]
Seller: [Total: 1000] [Available: 1000] [Frozen: 0]
```

### After Payment (Stage 1)
```
Buyer:  [Total: 1000] [Available: 500] [Frozen: 500]  ? Funds locked
Seller: [Total: 1000] [Available: 1000] [Frozen: 0]   ? No change
```

### After Shipment (Stage 2)
```
Buyer:  [Total: 1000] [Available: 500] [Frozen: 500]  ? Still locked
Seller: [Total: 1000] [Available: 1000] [Frozen: 0]   ? Still no change
```

### After Delivery Confirmation (Stage 3)
```
Buyer:  [Total: 500] [Available: 500] [Frozen: 0]     ? Funds deducted
Seller: [Total: 1500] [Available: 1500] [Frozen: 0]   ? Funds received
```

## Transaction History

### Payment (Stage 1)
```sql
INSERT INTO WalletTransactions
  (WalletId, Type, Amount, Currency, Description)
VALUES
  (BuyerWalletId, 'Freeze', 500, 'PKR', 'Payment for order {orderId}')
```

### Delivery Confirmation (Stage 3)
```sql
-- Buyer transaction
INSERT INTO WalletTransactions
  (WalletId, Type, Amount, Currency, Description)
VALUES
  (BuyerWalletId, 'FrozenToDebit', 500, 'PKR', 'Payment completed for order {orderId}')

-- Seller transaction
INSERT INTO WalletTransactions
  (WalletId, Type, Amount, Currency, Description)
VALUES
  (SellerWalletId, 'Credit', 500, 'PKR', 'Payment received for order {orderId}')
```

## FAQ

### Q: When are funds actually deducted from buyer's total balance?
**A:** During delivery confirmation (Stage 3), not during payment (Stage 1).

### Q: When does the seller receive the money?
**A:** During delivery confirmation (Stage 3), when buyer confirms receipt.

### Q: What if buyer never confirms delivery?
**A:** Orders have an auto-completion expiry (48 hours). After expiry, order is auto-completed and seller gets paid.

### Q: Can buyer cancel after payment?
**A:** Yes, but only before shipment. The frozen funds would be unfrozen and returned to available balance.

### Q: Are funds frozen twice?
**A:** ? NO! Funds are frozen ONCE during payment. Delivery confirmation only transfers the already-frozen funds.

### Q: What prevents double-freezing?
**A:** The code checks `order.IsAmountFrozen` before allowing any freeze operations. This flag is set to `true` during payment and cannot be frozen again.

---

**Legend:**
- ?? = Freeze operation (locks funds)
- ?? = Transfer operation (moves funds)
- ? = Operation completed successfully
- ? = Operation not allowed / incorrect understanding
