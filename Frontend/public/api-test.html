<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YaqeenPay API Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    
    h1, h2, h3 {
      color: #1976d2;
    }
    
    .card {
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    button {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    button:hover {
      background-color: #1565c0;
    }
    
    button.secondary {
      background-color: #f50057;
    }
    
    button.secondary:hover {
      background-color: #c51162;
    }
    
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    textarea {
      min-height: 100px;
      font-family: monospace;
    }
    
    .output {
      background-color: #f5f5f5;
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
      overflow: auto;
      max-height: 400px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    
    .status {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .success {
      color: #4caf50;
    }
    
    .error {
      color: #f44336;
    }
    
    .token-status {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }
    
    .token-item {
      flex: 1;
      padding: 10px;
      border-radius: 4px;
      background-color: #f5f5f5;
    }
    
    .token-label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .token-value {
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>YaqeenPay API Test</h1>
  
  <div class="card">
    <h2>Authentication Status</h2>
    <div class="token-status" id="token-status">
      <div class="token-item">
        <div class="token-label">Access Token:</div>
        <div class="token-value" id="access-token-display">Not set</div>
      </div>
      <div class="token-item">
        <div class="token-label">Refresh Token:</div>
        <div class="token-value" id="refresh-token-display">Not set</div>
      </div>
      <div class="token-item">
        <div class="token-label">Token Expiry:</div>
        <div class="token-value" id="token-expiry-display">Not set</div>
      </div>
    </div>
    <button onclick="checkTokens()">Refresh Token Status</button>
    <button onclick="clearTokens()" class="secondary">Clear All Tokens</button>
  </div>
  
  <div class="card">
    <h2>Login</h2>
    <div>
      <input type="text" id="email" placeholder="Email" value="admin@yaqeenpay.com">
      <input type="password" id="password" placeholder="Password" value="Admin@123456">
      <button onclick="login()">Login</button>
    </div>
    <div class="status" id="login-status"></div>
    <div class="output" id="login-output"></div>
  </div>
  
  <div class="card">
    <h2>Manual Token Setup</h2>
    <div>
      <input type="text" id="access-token" placeholder="Access Token">
      <input type="text" id="refresh-token" placeholder="Refresh Token">
      <input type="text" id="expiry" placeholder="Expiry (ISO date or milliseconds)">
      <button onclick="setTokensManually()">Set Tokens</button>
    </div>
    <div class="status" id="manual-status"></div>
  </div>
  
  <div class="card">
    <h2>Fix From Response JSON</h2>
    <div>
      <textarea id="response-json" placeholder="Paste raw JSON response here"></textarea>
      <button onclick="fixFromJson()">Apply JSON</button>
    </div>
    <div class="status" id="fix-status"></div>
  </div>
  
  <div class="card">
    <h2>Get User Profile</h2>
    <button onclick="getUserProfile()">Get Profile</button>
    <div class="status" id="profile-status"></div>
    <div class="output" id="profile-output"></div>
  </div>
  
  <div class="card">
    <h2>Test Protected API</h2>
    <input type="text" id="api-path" placeholder="API Path (e.g., /profile)" value="/profile">
    <button onclick="callProtectedApi()">Call API</button>
    <div class="status" id="api-status"></div>
    <div class="output" id="api-output"></div>
  </div>
  
  <script>
    // Base API URL
    const API_BASE_URL = 'https://localhost:7137/api';
    
    // Check token status
    function checkTokens() {
      const accessToken = localStorage.getItem('access_token');
      const refreshToken = localStorage.getItem('refresh_token');
      const tokenExpiry = localStorage.getItem('token_expiry');
      
      document.getElementById('access-token-display').textContent = 
        accessToken ? `${accessToken.substring(0, 20)}...` : 'Not set';
      
      document.getElementById('refresh-token-display').textContent = 
        refreshToken ? `${refreshToken.substring(0, 20)}...` : 'Not set';
      
      if (tokenExpiry) {
        const expiryDate = new Date(parseInt(tokenExpiry));
        const now = new Date();
        const isExpired = now > expiryDate;
        
        document.getElementById('token-expiry-display').textContent = 
          `${expiryDate.toLocaleString()} ${isExpired ? '(EXPIRED)' : ''}`;
        
        document.getElementById('token-expiry-display').classList.toggle('error', isExpired);
      } else {
        document.getElementById('token-expiry-display').textContent = 'Not set';
      }
      
      console.log('Token status checked:', {
        accessToken: accessToken ? `${accessToken.substring(0, 10)}...` : null,
        refreshToken: refreshToken ? `${refreshToken.substring(0, 10)}...` : null,
        tokenExpiry: tokenExpiry ? new Date(parseInt(tokenExpiry)).toISOString() : null
      });
    }
    
    // Clear all tokens
    function clearTokens() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      localStorage.removeItem('token_expiry');
      
      document.getElementById('access-token-display').textContent = 'Not set';
      document.getElementById('refresh-token-display').textContent = 'Not set';
      document.getElementById('token-expiry-display').textContent = 'Not set';
      
      console.log('All tokens cleared');
    }
    
    // Login function
    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const statusEl = document.getElementById('login-status');
      const outputEl = document.getElementById('login-output');
      
      statusEl.textContent = 'Logging in...';
      statusEl.className = 'status';
      
      try {
        console.log(`Logging in with ${email}`);
        
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });
        
        console.log('Login response status:', response.status);
        
        const data = await response.json();
        console.log('Login response data:', data);
        
        outputEl.textContent = JSON.stringify(data, null, 2);
        
        if (response.ok) {
          // Handle successful login
          statusEl.textContent = 'Login successful!';
          statusEl.className = 'status success';
          
          // Extract token data
          const tokenData = data.success !== undefined ? data.data : data;
          
          if (!tokenData || (!tokenData.token && !tokenData.accessToken)) {
            statusEl.textContent = 'Login successful but no token in response!';
            statusEl.className = 'status error';
            return;
          }
          
          // Store tokens
          const token = tokenData.token || tokenData.accessToken;
          if (token) {
            localStorage.setItem('access_token', token);
            console.log('Access token stored:', token.substring(0, 10) + '...');
          }
          
          if (tokenData.refreshToken) {
            localStorage.setItem('refresh_token', tokenData.refreshToken);
            console.log('Refresh token stored');
          }
          
          // Set expiry
          const expiryTime = tokenData.tokenExpires 
            ? new Date(tokenData.tokenExpires).getTime()
            : (Date.now() + 3600 * 1000);
            
          localStorage.setItem('token_expiry', expiryTime.toString());
          console.log('Token expiry set to:', new Date(expiryTime).toLocaleString());
          
          // Update token display
          checkTokens();
        } else {
          statusEl.textContent = `Login failed: ${response.status} ${response.statusText}`;
          statusEl.className = 'status error';
        }
      } catch (error) {
        console.error('Login error:', error);
        statusEl.textContent = `Error: ${error.message}`;
        statusEl.className = 'status error';
        outputEl.textContent = error.toString();
      }
    }
    
    // Set tokens manually
    function setTokensManually() {
      const accessToken = document.getElementById('access-token').value;
      const refreshToken = document.getElementById('refresh-token').value;
      const expiry = document.getElementById('expiry').value;
      const statusEl = document.getElementById('manual-status');
      
      try {
        if (!accessToken) {
          throw new Error('Access token is required');
        }
        
        // Store access token
        localStorage.setItem('access_token', accessToken);
        
        // Store refresh token if provided
        if (refreshToken) {
          localStorage.setItem('refresh_token', refreshToken);
        }
        
        // Parse and store expiry
        let expiryTime;
        if (expiry) {
          // Try parsing as number (milliseconds)
          if (!isNaN(expiry)) {
            expiryTime = parseInt(expiry);
          } 
          // Try parsing as ISO date
          else {
            expiryTime = new Date(expiry).getTime();
          }
          
          if (isNaN(expiryTime)) {
            throw new Error('Invalid expiry format');
          }
        } else {
          // Default 1 hour expiry
          expiryTime = Date.now() + 3600 * 1000;
        }
        
        localStorage.setItem('token_expiry', expiryTime.toString());
        
        statusEl.textContent = 'Tokens set successfully!';
        statusEl.className = 'status success';
        
        // Update token display
        checkTokens();
      } catch (error) {
        console.error('Error setting tokens:', error);
        statusEl.textContent = `Error: ${error.message}`;
        statusEl.className = 'status error';
      }
    }
    
    // Fix tokens from raw JSON response
    function fixFromJson() {
      const jsonText = document.getElementById('response-json').value;
      const statusEl = document.getElementById('fix-status');
      
      try {
        if (!jsonText) {
          throw new Error('JSON response is required');
        }
        
        const data = JSON.parse(jsonText);
        console.log('Parsed JSON:', data);
        
        // Extract token data
        const tokenData = data.success !== undefined ? data.data : data;
        
        if (!tokenData || (!tokenData.token && !tokenData.accessToken)) {
          throw new Error('No token found in the JSON response');
        }
        
        // Store tokens
        const token = tokenData.token || tokenData.accessToken;
        if (token) {
          localStorage.setItem('access_token', token);
          console.log('Access token stored:', token.substring(0, 10) + '...');
        }
        
        if (tokenData.refreshToken) {
          localStorage.setItem('refresh_token', tokenData.refreshToken);
          console.log('Refresh token stored');
        }
        
        // Set expiry
        const expiryTime = tokenData.tokenExpires 
          ? new Date(tokenData.tokenExpires).getTime()
          : (Date.now() + 3600 * 1000);
          
        localStorage.setItem('token_expiry', expiryTime.toString());
        console.log('Token expiry set to:', new Date(expiryTime).toLocaleString());
        
        statusEl.textContent = 'Tokens applied from JSON successfully!';
        statusEl.className = 'status success';
        
        // Update token display
        checkTokens();
      } catch (error) {
        console.error('Error fixing from JSON:', error);
        statusEl.textContent = `Error: ${error.message}`;
        statusEl.className = 'status error';
      }
    }
    
    // Get user profile
    async function getUserProfile() {
      const statusEl = document.getElementById('profile-status');
      const outputEl = document.getElementById('profile-output');
      
      statusEl.textContent = 'Fetching profile...';
      statusEl.className = 'status';
      
      try {
        const token = localStorage.getItem('access_token');
        
        if (!token) {
          throw new Error('No access token available');
        }
        
        const response = await fetch(`${API_BASE_URL}/profile`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('Profile response status:', response.status);
        
        const data = await response.json();
        console.log('Profile response data:', data);
        
        outputEl.textContent = JSON.stringify(data, null, 2);
        
        if (response.ok) {
          statusEl.textContent = 'Profile fetched successfully!';
          statusEl.className = 'status success';
        } else {
          statusEl.textContent = `Failed to fetch profile: ${response.status} ${response.statusText}`;
          statusEl.className = 'status error';
        }
      } catch (error) {
        console.error('Profile error:', error);
        statusEl.textContent = `Error: ${error.message}`;
        statusEl.className = 'status error';
        outputEl.textContent = error.toString();
      }
    }
    
    // Call protected API
    async function callProtectedApi() {
      const apiPath = document.getElementById('api-path').value;
      const statusEl = document.getElementById('api-status');
      const outputEl = document.getElementById('api-output');
      
      statusEl.textContent = `Calling API: ${apiPath}...`;
      statusEl.className = 'status';
      
      try {
        const token = localStorage.getItem('access_token');
        
        if (!token) {
          throw new Error('No access token available');
        }
        
        const response = await fetch(`${API_BASE_URL}${apiPath.startsWith('/') ? apiPath : '/' + apiPath}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log(`API response status for ${apiPath}:`, response.status);
        
        const data = await response.json();
        console.log('API response data:', data);
        
        outputEl.textContent = JSON.stringify(data, null, 2);
        
        if (response.ok) {
          statusEl.textContent = 'API call successful!';
          statusEl.className = 'status success';
        } else {
          statusEl.textContent = `API call failed: ${response.status} ${response.statusText}`;
          statusEl.className = 'status error';
        }
      } catch (error) {
        console.error('API call error:', error);
        statusEl.textContent = `Error: ${error.message}`;
        statusEl.className = 'status error';
        outputEl.textContent = error.toString();
      }
    }
    
    // Check tokens on page load
    document.addEventListener('DOMContentLoaded', checkTokens);
  </script>
</body>
</html>